import sys
import time
import pandas as pd
import numpy as np
from sqlalchemy import create_engine, text
import logging
from typing import Dict, List, Optional
from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                             QLabel, QPushButton, QTableWidget, QTableWidgetItem, QHeaderView,
                             QMessageBox, QGroupBox, QTabWidget, QComboBox, QSpinBox,
                             QDateEdit, QLineEdit, QCheckBox, QFileDialog, QSplitter,
                             QFrame, QGridLayout, QToolButton, QMenu)
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QDate, QTimer, QPropertyAnimation, QEasingCurve
from PyQt5.QtGui import QFont, QColor, QBrush, QPalette, QIcon, QLinearGradient
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import seaborn as sns

# è¨­å®š Matplotlib å…¨å±€å­—é«”ä»¥æ”¯æ´ä¸­æ–‡
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei']
plt.rcParams['axes.unicode_minus'] = False

# é…ç½®æ—¥èªŒ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# å„ªåŒ–çš„é¡è‰²æ–¹æ¡ˆ - ç¾ä»£åŒ–æ·±è‰²ä¸»é¡Œ
COLORS = {
    'bg_dark': "#0F0F1E",
    'bg_medium': "#1A1B3A",
    'bg_light': "#2A2B5A",
    'bg_lighter': "#3A3B6A",
    'bg_card': "#252647",
    'text_light': "#E8E9F3",
    'text_dim': "#A8A9C3",
    'text_muted': "#7879A3",
    'accent': "#6C63FF",
    'accent_alt': "#8B80FF",
    'accent_glow': "#9D94FF",
    'success': "#4ADE80",
    'error': "#EF4444",
    'warning': "#FBBF24",
    'info': "#3B82F6",
    'neutral': "#64748B",
    'gain': "#10B981",
    'gain_light': "#34D399",
    'loss': "#F43F5E",
    'loss_light': "#FB7185",
    'gradient_start': "#667EEA",
    'gradient_end': "#764BA2",
}


class ReturnRankingWorker(QThread):
    """è¨ˆç®—å ±é…¬ç‡æ’è¡Œçš„å·¥ä½œç·šç¨‹"""
    progress_update = pyqtSignal(str)
    result_ready = pyqtSignal(pd.DataFrame)
    error_occurred = pyqtSignal(str)

    def __init__(self, db_config: Dict, frequency: str, date_range: tuple,
                 top_n: int = 50, include_negative: bool = True):
        super().__init__()
        self.db_config = db_config
        self.frequency = frequency
        self.start_date, self.end_date = date_range
        self.top_n = top_n
        self.include_negative = include_negative

    def run(self):
        """åŸ·è¡Œå ±é…¬ç‡æ’è¡Œè¨ˆç®—"""
        try:
            self.progress_update.emit("æ­£åœ¨é€£æ¥è³‡æ–™åº«...")

            db_uri = f"postgresql://{self.db_config['user']}:{self.db_config['password']}@{self.db_config['host']}:{self.db_config['port']}/{self.db_config['dbname']}"
            engine = create_engine(db_uri)

            self.progress_update.emit(f"æ­£åœ¨æŸ¥è©¢{self.frequency}å ±é…¬ç‡æ•¸æ“š...")

            query = f"""
            WITH latest_returns AS (
                SELECT
                    ticker,
                    "Date",
                    "return",
                    ROW_NUMBER() OVER (PARTITION BY ticker ORDER BY "Date" DESC) as rn
                FROM taiwan_stock_returns
                WHERE frequency = '{self.frequency}'
                AND "Date" BETWEEN '{self.start_date}' AND '{self.end_date}'
            ),
            avg_returns AS (
                SELECT
                    ticker,
                    AVG("return") as avg_return,
                    COUNT(*) as data_points,
                    MIN("Date") as first_date,
                    MAX("Date") as last_date
                FROM taiwan_stock_returns
                WHERE frequency = '{self.frequency}'
                AND "Date" BETWEEN '{self.start_date}' AND '{self.end_date}'
                GROUP BY ticker
            )
            SELECT
                lr.ticker,
                lr."return" as latest_return,
                lr."Date" as latest_date,
                ar.avg_return,
                ar.data_points,
                ar.first_date,
                ar.last_date
            FROM latest_returns lr
            JOIN avg_returns ar ON lr.ticker = ar.ticker
            WHERE lr.rn = 1
            ORDER BY lr."return" DESC
            """

            df = pd.read_sql(query, engine)

            if df.empty:
                self.error_occurred.emit("æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„å ±é…¬ç‡æ•¸æ“š")
                return

            self.progress_update.emit("æ­£åœ¨æŸ¥è©¢è‚¡ç¥¨åç¨±...")

            ticker_list = df['ticker'].unique().tolist()
            ticker_names = {}

            for i in range(0, len(ticker_list), 100):
                batch = ticker_list[i:i+100]
                ticker_str = "','".join(batch)
                try:
                    name_query = f"""
                    SELECT DISTINCT ticker, ticker as name
                    FROM taiwan_stock_prices
                    WHERE ticker IN ('{ticker_str}')
                    """
                    name_df = pd.read_sql(name_query, engine)
                    for _, row in name_df.iterrows():
                        ticker_names[row['ticker']] = row['name']
                except:
                    pass

            df['name'] = df['ticker'].map(ticker_names).fillna('æœªçŸ¥')
            df['latest_return_pct'] = df['latest_return'] * 100
            df['avg_return_pct'] = df['avg_return'] * 100

            if not self.include_negative:
                df = df[df['latest_return'] > 0]

            if len(df) > self.top_n * 2:
                top_df = df.head(self.top_n)
                bottom_df = df.tail(self.top_n)
                df = pd.concat([top_df, bottom_df])

            self.progress_update.emit("å ±é…¬ç‡æ’è¡Œè¨ˆç®—å®Œæˆ")
            self.result_ready.emit(df)

        except Exception as e:
            error_msg = f"è¨ˆç®—å ±é…¬ç‡æ’è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"
            logger.error(error_msg)
            self.error_occurred.emit(error_msg)


class StyledButton(QPushButton):
    """ç¾ä»£åŒ–é¢¨æ ¼æŒ‰éˆ•"""
    def __init__(self, text, parent=None, accent=False, icon=None):
        super().__init__(text, parent)
        self.setMinimumHeight(42)
        self.setCursor(Qt.PointingHandCursor)
        
        if icon:
            self.setText(f"  {text}")
        
        if accent:
            self.setStyleSheet(f"""
                QPushButton {{
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 {COLORS['gradient_start']}, stop:1 {COLORS['gradient_end']});
                    color: white;
                    font-weight: bold;
                    font-size: 14px;
                    border: none;
                    border-radius: 8px;
                    padding: 10px 24px;
                }}
                QPushButton:hover {{
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 {COLORS['accent_alt']}, stop:1 {COLORS['gradient_end']});
                }}
                QPushButton:pressed {{
                    padding: 11px 24px 9px 24px;
                }}
            """)
        else:
            self.setStyleSheet(f"""
                QPushButton {{
                    background-color: {COLORS['bg_card']};
                    color: {COLORS['text_light']};
                    font-size: 14px;
                    border: 2px solid {COLORS['bg_lighter']};
                    border-radius: 8px;
                    padding: 10px 20px;
                }}
                QPushButton:hover {{
                    background-color: {COLORS['bg_light']};
                    border: 2px solid {COLORS['accent']};
                }}
                QPushButton:pressed {{
                    background-color: {COLORS['bg_lighter']};
                    padding: 11px 20px 9px 20px;
                }}
            """)


class ReturnChart(FigureCanvas):
    """å„ªåŒ–çš„å ±é…¬ç‡åœ–è¡¨å…ƒä»¶"""
    def __init__(self, parent=None):
        self.fig = Figure(figsize=(12, 8), facecolor=COLORS['bg_medium'])
        super().__init__(self.fig)
        self.setParent(parent)

    def update_chart(self, df: pd.DataFrame, title: str):
        """æ›´æ–°åœ–è¡¨"""
        self.fig.clear()
        ax = self.fig.add_subplot(111, facecolor=COLORS['bg_dark'])

        if df.empty:
            ax.text(0.5, 0.5, 'æš«ç„¡æ•¸æ“š', ha='center', va='center',
                    transform=ax.transAxes, color=COLORS['text_dim'], fontsize=18)
            self.draw()
            return

        df_sorted = df.copy()
        if "æ¼²å¹…" in title or "Top" in title:
            df_sorted = df_sorted.sort_values('latest_return_pct', ascending=True)
        else:
            df_sorted = df_sorted.sort_values('latest_return_pct', ascending=False)

        # ä½¿ç”¨æ¼¸å±¤é¡è‰²
        colors = []
        for x in df_sorted['latest_return_pct']:
            if x > 5:
                colors.append(COLORS['gain'])
            elif x > 0:
                colors.append(COLORS['gain_light'])
            elif x > -5:
                colors.append(COLORS['loss_light'])
            else:
                colors.append(COLORS['loss'])

        bars = ax.barh(range(len(df_sorted)), df_sorted['latest_return_pct'],
                       color=colors, alpha=0.85, height=0.75, edgecolor=COLORS['bg_lighter'], linewidth=0.5)

        # è¨­ç½®Yè»¸æ¨™ç±¤
        ax.set_yticks(range(len(df_sorted)))
        labels = [f"{row['ticker']} {row['name'][:6]}" for _, row in df_sorted.iterrows()]
        ax.set_yticklabels(labels, fontfamily='Microsoft JhengHei', fontsize=11)
        
        # è¨­ç½®æ¨™é¡Œå’Œæ¨™ç±¤
        ax.set_xlabel('å ±é…¬ç‡ (%)', color=COLORS['text_light'], fontsize=14, fontweight='bold')
        ax.set_title(title, color=COLORS['text_light'], fontsize=20, pad=25, fontweight='bold')
        
        # ç¾åŒ–è»¸ç·šå’Œç¶²æ ¼
        ax.tick_params(axis='x', colors=COLORS['text_dim'], labelsize=12)
        ax.tick_params(axis='y', colors=COLORS['text_light'], labelsize=11)
        ax.spines['top'].set_visible(False)
        ax.spines['right'].set_visible(False)
        ax.spines['bottom'].set_color(COLORS['bg_lighter'])
        ax.spines['left'].set_color(COLORS['bg_lighter'])
        ax.grid(True, axis='x', linestyle='--', color=COLORS['bg_lighter'], alpha=0.3, linewidth=0.5)
        ax.grid(False, axis='y')
        
        # æ·»åŠ 0åŸºæº–ç·š
        ax.axvline(x=0, color=COLORS['text_muted'], linestyle='-', linewidth=1.5, alpha=0.5)

        # æ·»åŠ æ•¸å€¼æ¨™ç±¤
        for i, (bar, value) in enumerate(zip(bars, df_sorted['latest_return_pct'])):
            if value > 0:
                ha_align = 'left'
                pad = 0.3
                bg_color = COLORS['gain'] if value > 5 else COLORS['gain_light']
            else:
                ha_align = 'right'
                pad = -0.3
                bg_color = COLORS['loss'] if value < -5 else COLORS['loss_light']
                
            ax.text(value + pad, i,
                    f'{value:.2f}%', va='center', ha=ha_align,
                    color='white', fontsize=10, fontweight='bold',
                    bbox=dict(facecolor=bg_color, alpha=0.8, edgecolor='none', 
                             pad=2, boxstyle='round,pad=0.3'))

        self.fig.tight_layout()
        self.draw()


class NumericTableWidgetItem(QTableWidgetItem):
    """è‡ªè¨‚çš„è¡¨æ ¼é …ç›®ï¼Œç”¨æ–¼æ­£ç¢ºæ’åºæ•¸å€¼"""
    def __init__(self, text, numeric_value):
        super().__init__(text)
        self.numeric_value = numeric_value

    def __lt__(self, other):
        if isinstance(other, NumericTableWidgetItem):
            return self.numeric_value < other.numeric_value
        return super().__lt__(other)


class InfoCard(QFrame):
    """è³‡è¨Šå¡ç‰‡å…ƒä»¶"""
    def __init__(self, title, value, color=None, parent=None):
        super().__init__(parent)
        self.setFrameStyle(QFrame.Box)
        self.setStyleSheet(f"""
            QFrame {{
                background-color: {COLORS['bg_card']};
                border: 1px solid {COLORS['bg_lighter']};
                border-radius: 10px;
                padding: 15px;
            }}
        """)
        
        layout = QVBoxLayout(self)
        
        title_label = QLabel(title)
        title_label.setStyleSheet(f"""
            color: {COLORS['text_muted']};
            font-size: 12px;
            font-weight: bold;
        """)
        
        self.value_label = QLabel(value)
        value_color = color if color else COLORS['text_light']
        self.value_label.setStyleSheet(f"""
            color: {value_color};
            font-size: 24px;
            font-weight: bold;
        """)
        
        layout.addWidget(title_label)
        layout.addWidget(self.value_label)
        layout.setSpacing(5)
        
    def update_value(self, value, color=None):
        self.value_label.setText(value)
        if color:
            self.value_label.setStyleSheet(f"""
                color: {color};
                font-size: 24px;
                font-weight: bold;
            """)


class ReturnRankingWindow(QMainWindow):
    """è‚¡ç¥¨å ±é…¬ç‡æ’è¡Œç³»çµ±ä¸»è¦–çª—"""
    def __init__(self):
        super().__init__()
        self.db_config = {
            "host": "localhost",
            "port": "5432",
            "user": "postgres",
            "password": "s8304021",
            "dbname": "postgres"
        }
        self.current_df = None
        self.init_ui()

    def init_ui(self):
        """åˆå§‹åŒ–ä½¿ç”¨è€…ç•Œé¢"""
        self.setWindowTitle("æ™ºèƒ½è‚¡å¸‚åˆ†æç³»çµ± - å ±é…¬ç‡å…‰è­œåˆ†æå„€")
        self.setGeometry(50, 50, 1700, 950)

        # è¨­å®šå…¨å±€æ¨£å¼
        self.setStyleSheet(f"""
            QMainWindow, QWidget {{
                background-color: {COLORS['bg_dark']};
                color: {COLORS['text_light']};
                font-family: 'Microsoft JhengHei UI', 'Segoe UI', sans-serif;
                font-size: 13px;
            }}
            QLabel {{
                color: {COLORS['text_light']};
            }}
            QGroupBox {{
                background-color: {COLORS['bg_card']};
                border: 2px solid {COLORS['bg_lighter']};
                border-radius: 12px;
                margin-top: 20px;
                padding-top: 20px;
                font-weight: bold;
                font-size: 14px;
            }}
            QGroupBox::title {{
                subcontrol-origin: margin;
                subcontrol-position: top left;
                left: 15px;
                padding: 5px 15px;
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {COLORS['accent']}, stop:1 {COLORS['accent_alt']});
                color: white;
                border-radius: 8px;
            }}
            QTableWidget {{
                background-color: {COLORS['bg_medium']};
                alternate-background-color: {COLORS['bg_card']};
                gridline-color: {COLORS['bg_lighter']};
                border: 1px solid {COLORS['bg_lighter']};
                border-radius: 8px;
                selection-background-color: {COLORS['accent']};
            }}
            QTableWidget::item {{
                padding: 10px;
                border-bottom: 1px solid {COLORS['bg_lighter']};
            }}
            QTableWidget::item:selected {{
                background-color: {COLORS['accent']};
                color: white;
            }}
            QHeaderView::section {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {COLORS['bg_light']}, stop:1 {COLORS['bg_lighter']});
                color: {COLORS['text_light']};
                padding: 12px;
                border: none;
                font-weight: bold;
                font-size: 13px;
                border-right: 1px solid {COLORS['bg_medium']};
            }}
            QComboBox, QDateEdit, QSpinBox, QLineEdit {{
                background-color: {COLORS['bg_card']};
                color: {COLORS['text_light']};
                border: 2px solid {COLORS['bg_lighter']};
                border-radius: 6px;
                padding: 8px 12px;
                font-size: 13px;
            }}
            QComboBox:hover, QDateEdit:hover, QSpinBox:hover, QLineEdit:hover {{
                border: 2px solid {COLORS['accent']};
                background-color: {COLORS['bg_light']};
            }}
            QComboBox::drop-down {{
                border: none;
                width: 30px;
            }}
            QComboBox::down-arrow {{
                image: none;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 5px solid {COLORS['text_dim']};
                margin-right: 5px;
            }}
            QCheckBox {{
                spacing: 8px;
                font-size: 13px;
            }}
            QCheckBox::indicator {{
                width: 20px;
                height: 20px;
                border: 2px solid {COLORS['bg_lighter']};
                border-radius: 4px;
                background-color: {COLORS['bg_card']};
            }}
            QCheckBox::indicator:checked {{
                background-color: {COLORS['accent']};
                border: 2px solid {COLORS['accent']};
            }}
            QCheckBox::indicator:hover {{
                border: 2px solid {COLORS['accent_alt']};
            }}
            QScrollBar:vertical {{
                border: none;
                background: {COLORS['bg_dark']};
                width: 14px;
                border-radius: 7px;
            }}
            QScrollBar::handle:vertical {{
                background: {COLORS['bg_lighter']};
                min-height: 30px;
                border-radius: 7px;
            }}
            QScrollBar::handle:vertical:hover {{
                background: {COLORS['accent']};
            }}
            QScrollBar:horizontal {{
                border: none;
                background: {COLORS['bg_dark']};
                height: 14px;
                border-radius: 7px;
            }}
            QScrollBar::handle:horizontal {{
                background: {COLORS['bg_lighter']};
                min-width: 30px;
                border-radius: 7px;
            }}
            QScrollBar::handle:horizontal:hover {{
                background: {COLORS['accent']};
            }}
            QTabBar::tab {{
                background: {COLORS['bg_card']};
                color: {COLORS['text_dim']};
                padding: 12px 25px;
                margin-right: 4px;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                font-weight: bold;
                font-size: 14px;
            }}
            QTabBar::tab:hover {{
                background: {COLORS['bg_light']};
                color: {COLORS['text_light']};
            }}
            QTabBar::tab:selected {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {COLORS['accent']}, stop:0.5 {COLORS['accent_alt']}, stop:1 {COLORS['bg_medium']});
                color: white;
            }}
            QTabWidget::pane {{
                border: 2px solid {COLORS['bg_lighter']};
                background-color: {COLORS['bg_medium']};
                border-radius: 8px;
                top: -2px;
            }}
        """)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_layout = QVBoxLayout(central_widget)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(15)

        # æ¨™é¡Œå€åŸŸ
        title_widget = self.create_title_widget()
        main_layout.addWidget(title_widget)

        # è³‡è¨Šå¡ç‰‡å€åŸŸ
        self.info_cards_widget = self.create_info_cards()
        main_layout.addWidget(self.info_cards_widget)

        # æ§åˆ¶é¢æ¿
        control_panel = self.create_control_panel()
        main_layout.addWidget(control_panel)

        # å…§å®¹åˆ†å‰²å™¨
        content_splitter = QSplitter(Qt.Horizontal)
        table_widget = self.create_table_widget()
        chart_widget = self.create_chart_widget()

        content_splitter.addWidget(table_widget)
        content_splitter.addWidget(chart_widget)
        content_splitter.setSizes([950, 750])
        content_splitter.setStyleSheet(f"""
            QSplitter::handle {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {COLORS['bg_lighter']}, stop:0.5 {COLORS['accent']}, stop:1 {COLORS['bg_lighter']});
                width: 3px;
            }}
        """)

        main_layout.addWidget(content_splitter, 1)

        # ç‹€æ…‹åˆ—
        self.status_bar = self.create_status_bar()
        main_layout.addWidget(self.status_bar)

        # è‡ªå‹•åˆ·æ–°è¨ˆæ™‚å™¨
        self.auto_refresh_timer = QTimer()
        self.auto_refresh_timer.timeout.connect(self.refresh_data)

    def create_title_widget(self):
        """å‰µå»ºæ¨™é¡Œå€åŸŸ"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(5)
        
        # ä¸»æ¨™é¡Œ
        title = QLabel("æ™ºèƒ½è‚¡å¸‚åˆ†æç³»çµ±")
        title.setStyleSheet(f"""
            font-size: 42px;
            font-weight: 900;
            color: {COLORS['text_light']};
            letter-spacing: 3px;
            padding: 10px;
            background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 {COLORS['accent']}, stop:1 {COLORS['accent_alt']});
            -webkit-background-clip: text;
            background-clip: text;
        """)
        title.setAlignment(Qt.AlignCenter)
        
        # å‰¯æ¨™é¡Œ
        subtitle = QLabel("ğŸ“Š å ±é…¬ç‡å…‰è­œåˆ†æå„€ | Return Spectrum Analyzer v2.0")
        subtitle.setStyleSheet(f"""
            font-size: 18px;
            color: {COLORS['text_dim']};
            padding: 5px;
        """)
        subtitle.setAlignment(Qt.AlignCenter)
        
        layout.addWidget(title)
        layout.addWidget(subtitle)
        
        return widget

    def create_info_cards(self):
        """å‰µå»ºè³‡è¨Šå¡ç‰‡å€åŸŸ"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        layout.setSpacing(15)
        
        self.total_stocks_card = InfoCard("ç¸½åˆ†æè‚¡ç¥¨æ•¸", "0", COLORS['info'])
        self.avg_return_card = InfoCard("å¹³å‡å ±é…¬ç‡", "0.00%", COLORS['warning'])
        self.top_gainer_card = InfoCard("æœ€é«˜æ¼²å¹…", "0.00%", COLORS['gain'])
        self.top_loser_card = InfoCard("æœ€å¤§è·Œå¹…", "0.00%", COLORS['loss'])
        
        layout.addWidget(self.total_stocks_card)
        layout.addWidget(self.avg_return_card)
        layout.addWidget(self.top_gainer_card)
        layout.addWidget(self.top_loser_card)
        
        return widget

    def create_control_panel(self):
        """å‰µå»ºæ§åˆ¶é¢æ¿"""
        group = QGroupBox("ğŸ“‹ æŸ¥è©¢æ§åˆ¶é¢æ¿")
        layout = QGridLayout(group)
        layout.setSpacing(15)
        
        # é »ç‡é¸æ“‡
        freq_label = QLabel("ğŸ“ˆ é »ç‡é¸æ“‡:")
        freq_label.setStyleSheet("font-weight: bold;")
        self.frequency_combo = QComboBox()
        freq_items = [
            ('æ—¥å ±é…¬', 'daily'),
            ('é€±å ±é…¬', 'weekly'),
            ('æœˆå ±é…¬', 'monthly'),
            ('å­£å ±é…¬', 'quarterly'),
            ('å¹´å ±é…¬', 'yearly')
        ]
        for display, value in freq_items:
            self.frequency_combo.addItem(display, value)
        self.frequency_combo.setCurrentIndex(0)
        
        # æ—¥æœŸç¯„åœ
        date_label = QLabel("ğŸ“… æ—¥æœŸç¯„åœ:")
        date_label.setStyleSheet("font-weight: bold;")
        self.start_date = QDateEdit()
        self.start_date.setCalendarPopup(True)
        self.start_date.setDate(QDate.currentDate().addMonths(-1))
        self.start_date.setDisplayFormat("yyyy/MM/dd")
        
        date_to_label = QLabel("è‡³")
        date_to_label.setAlignment(Qt.AlignCenter)
        
        self.end_date = QDateEdit()
        self.end_date.setCalendarPopup(True)
        self.end_date.setDate(QDate.currentDate())
        self.end_date.setDisplayFormat("yyyy/MM/dd")
        
        # é¡¯ç¤ºç­†æ•¸
        top_n_label = QLabel("ğŸ“Š é¡¯ç¤ºç­†æ•¸:")
        top_n_label.setStyleSheet("font-weight: bold;")
        self.top_n_spin = QSpinBox()
        self.top_n_spin.setRange(10, 100)
        self.top_n_spin.setValue(50)
        self.top_n_spin.setSingleStep(10)
        self.top_n_spin.setSuffix(" ç­†")
        
        # é¸é …è¨­å®š
        self.include_negative_check = QCheckBox("åŒ…å«è² å ±é…¬è‚¡ç¥¨")
        self.include_negative_check.setChecked(True)
        
        self.auto_refresh_check = QCheckBox("è‡ªå‹•åˆ·æ–° (æ¯5åˆ†é˜)")
        self.auto_refresh_check.toggled.connect(self.toggle_auto_refresh)
        
        # æŒ‰éˆ•å€åŸŸ
        button_widget = QWidget()
        button_layout = QHBoxLayout(button_widget)
        button_layout.setSpacing(10)
        
        self.refresh_btn = StyledButton("ğŸ”„ åŸ·è¡Œåˆ†æ", accent=True)
        self.refresh_btn.clicked.connect(self.refresh_data)
        
        self.export_btn = StyledButton("ğŸ’¾ åŒ¯å‡ºå ±è¡¨")
        self.export_btn.clicked.connect(self.export_data)
        
        self.settings_btn = StyledButton("âš™ï¸ è¨­å®š")
        
        button_layout.addWidget(self.refresh_btn)
        button_layout.addWidget(self.export_btn)
        button_layout.addWidget(self.settings_btn)
        button_layout.addStretch()
        
        # æ’ç‰ˆ
        layout.addWidget(freq_label, 0, 0)
        layout.addWidget(self.frequency_combo, 0, 1)
        
        layout.addWidget(date_label, 0, 2)
        layout.addWidget(self.start_date, 0, 3)
        layout.addWidget(date_to_label, 0, 4)
        layout.addWidget(self.end_date, 0, 5)
        
        layout.addWidget(top_n_label, 0, 6)
        layout.addWidget(self.top_n_spin, 0, 7)
        
        layout.addWidget(self.include_negative_check, 1, 0, 1, 2)
        layout.addWidget(self.auto_refresh_check, 1, 2, 1, 2)
        layout.addWidget(button_widget, 1, 4, 1, 4)
        
        layout.setColumnStretch(8, 1)
        
        return group

    def create_table_widget(self):
        """å‰µå»ºè¡¨æ ¼å€åŸŸ"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(10)
        
        # æœå°‹å€åŸŸ
        search_widget = QWidget()
        search_widget.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_card']};
                border-radius: 8px;
                padding: 10px;
            }}
        """)
        search_layout = QHBoxLayout(search_widget)
        
        search_label = QLabel("ğŸ” å¿«é€Ÿæœå°‹:")
        search_label.setStyleSheet("font-weight: bold; font-size: 14px;")
        
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡Œéæ¿¾...")
        self.search_input.textChanged.connect(self.filter_table)
        self.search_input.setStyleSheet(f"""
            QLineEdit {{
                font-size: 14px;
                padding: 10px;
            }}
        """)
        
        clear_btn = QPushButton("æ¸…é™¤")
        clear_btn.clicked.connect(lambda: self.search_input.clear())
        clear_btn.setStyleSheet(f"""
            QPushButton {{
                background-color: {COLORS['bg_lighter']};
                color: {COLORS['text_light']};
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
                font-weight: bold;
            }}
            QPushButton:hover {{
                background-color: {COLORS['accent']};
            }}
        """)
        
        search_layout.addWidget(search_label)
        search_layout.addWidget(self.search_input, 1)
        search_layout.addWidget(clear_btn)
        
        layout.addWidget(search_widget)
        
        # è¡¨æ ¼
        self.ranking_table = QTableWidget()
        self.ranking_table.setColumnCount(8)
        self.ranking_table.setHorizontalHeaderLabels([
            "æ’å", "è‚¡ç¥¨ä»£ç¢¼", "è‚¡ç¥¨åç¨±", "æœ€æ–°å ±é…¬ç‡(%)",
            "å¹³å‡å ±é…¬ç‡(%)", "è³‡æ–™ç­†æ•¸", "æœ€æ–°æ—¥æœŸ", "çµ±è¨ˆæœŸé–“"
        ])
        
        header = self.ranking_table.horizontalHeader()
        header.setSectionResizeMode(QHeaderView.Interactive)
        header.setSectionResizeMode(2, QHeaderView.Stretch)  # è‚¡ç¥¨åç¨±æ¬„ä½è‡ªå‹•å»¶å±•
        
        # è¨­å®šæ¬„ä½å¯¬åº¦
        self.ranking_table.setColumnWidth(0, 80)   # æ’å
        self.ranking_table.setColumnWidth(1, 100)  # è‚¡ç¥¨ä»£ç¢¼
        self.ranking_table.setColumnWidth(3, 120)  # æœ€æ–°å ±é…¬ç‡
        self.ranking_table.setColumnWidth(4, 120)  # å¹³å‡å ±é…¬ç‡
        self.ranking_table.setColumnWidth(5, 100)  # è³‡æ–™ç­†æ•¸
        self.ranking_table.setColumnWidth(6, 110)  # æœ€æ–°æ—¥æœŸ
        self.ranking_table.setColumnWidth(7, 150)  # çµ±è¨ˆæœŸé–“
        
        self.ranking_table.setAlternatingRowColors(True)
        self.ranking_table.setSortingEnabled(True)
        self.ranking_table.verticalHeader().setVisible(False)
        self.ranking_table.setSelectionBehavior(QTableWidget.SelectRows)
        
        layout.addWidget(self.ranking_table)
        
        return widget

    def create_chart_widget(self):
        """å‰µå»ºåœ–è¡¨å€åŸŸ"""
        self.chart_tabs = QTabWidget()
        
        self.top_chart = ReturnChart()
        self.bottom_chart = ReturnChart()
        
        self.chart_tabs.addTab(self.top_chart, "ğŸ“ˆ æ¼²å¹…æ’è¡Œæ¦œ Top 20")
        self.chart_tabs.addTab(self.bottom_chart, "ğŸ“‰ è·Œå¹…æ’è¡Œæ¦œ Top 20")
        
        return self.chart_tabs

    def create_status_bar(self):
        """å‰µå»ºç‹€æ…‹åˆ—"""
        widget = QWidget()
        widget.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_card']};
                border-radius: 8px;
                padding: 10px;
            }}
        """)
        layout = QHBoxLayout(widget)
        
        self.status_label = QLabel("âš¡ ç³»çµ±å°±ç·’")
        self.status_label.setStyleSheet(f"""
            color: {COLORS['success']};
            font-size: 14px;
            font-weight: bold;
        """)
        
        self.last_update_label = QLabel("æœ€å¾Œæ›´æ–°: --")
        self.last_update_label.setStyleSheet(f"""
            color: {COLORS['text_dim']};
            font-size: 13px;
        """)
        
        layout.addWidget(self.status_label)
        layout.addStretch()
        layout.addWidget(self.last_update_label)
        
        return widget

    def refresh_data(self):
        """åˆ·æ–°æ•¸æ“š"""
        self.refresh_btn.setEnabled(False)
        self.status_label.setText("â³ æ­£åœ¨åŸ·è¡Œåˆ†æï¼Œè«‹ç¨å€™...")
        self.status_label.setStyleSheet(f"color: {COLORS['warning']}; font-size: 14px; font-weight: bold;")
        
        frequency_value = self.frequency_combo.currentData()
        start_date = self.start_date.date().toString("yyyy-MM-dd")
        end_date = self.end_date.date().toString("yyyy-MM-dd")
        top_n = self.top_n_spin.value()
        include_negative = self.include_negative_check.isChecked()
        
        self.worker = ReturnRankingWorker(
            self.db_config, frequency_value, (start_date, end_date),
            top_n, include_negative
        )
        
        self.worker.progress_update.connect(self.update_status)
        self.worker.result_ready.connect(self.display_results)
        self.worker.error_occurred.connect(self.handle_error)
        
        self.worker.start()

    def display_results(self, df: pd.DataFrame):
        """é¡¯ç¤ºæŸ¥è©¢çµæœ"""
        self.current_df = df
        self.refresh_btn.setEnabled(True)
        
        # æ›´æ–°è³‡è¨Šå¡ç‰‡
        if not df.empty:
            self.total_stocks_card.update_value(str(len(df)), COLORS['info'])
            avg_return = df['latest_return_pct'].mean()
            avg_color = COLORS['gain'] if avg_return > 0 else COLORS['loss']
            self.avg_return_card.update_value(f"{avg_return:.2f}%", avg_color)
            
            max_return = df['latest_return_pct'].max()
            self.top_gainer_card.update_value(f"{max_return:.2f}%", COLORS['gain'])
            
            min_return = df['latest_return_pct'].min()
            self.top_loser_card.update_value(f"{min_return:.2f}%", COLORS['loss'])
        
        # ç¦ç”¨æ’åºä»¥æå‡æ•ˆèƒ½
        self.ranking_table.setSortingEnabled(False)
        
        # å¡«å……è¡¨æ ¼
        self.ranking_table.setRowCount(0)
        self.ranking_table.setRowCount(len(df))
        
        for i, (_, row) in enumerate(df.iterrows()):
            # æ’å
            rank_val = i + 1
            rank_item = NumericTableWidgetItem(f"#{rank_val}", rank_val)
            rank_item.setTextAlignment(Qt.AlignCenter)
            rank_item.setFont(QFont("Arial", 11, QFont.Bold))
            if rank_val <= 3:
                rank_item.setForeground(QBrush(QColor(COLORS['warning'])))
            else:
                rank_item.setForeground(QBrush(QColor(COLORS['text_dim'])))
            
            # è‚¡ç¥¨ä»£ç¢¼
            ticker_item = QTableWidgetItem(row['ticker'])
            ticker_item.setFont(QFont("Consolas", 11, QFont.Bold))
            ticker_item.setTextAlignment(Qt.AlignCenter)
            
            # è‚¡ç¥¨åç¨±
            name_item = QTableWidgetItem(row['name'])
            name_item.setFont(QFont("Microsoft JhengHei", 11))
            
            # æœ€æ–°å ±é…¬ç‡
            latest_return = row['latest_return_pct']
            latest_return_item = NumericTableWidgetItem(f"{latest_return:+.2f}%", latest_return)
            latest_return_item.setTextAlignment(Qt.AlignRight | Qt.AlignVCenter)
            latest_return_item.setFont(QFont("Arial", 11, QFont.Bold))
            if latest_return > 0:
                latest_return_item.setForeground(QBrush(QColor(COLORS['gain'])))
                latest_return_item.setBackground(QBrush(QColor(COLORS['gain']).darker(800)))
            elif latest_return < 0:
                latest_return_item.setForeground(QBrush(QColor(COLORS['loss'])))
                latest_return_item.setBackground(QBrush(QColor(COLORS['loss']).darker(800)))
            
            # å¹³å‡å ±é…¬ç‡
            avg_return = row['avg_return_pct']
            avg_return_item = NumericTableWidgetItem(f"{avg_return:+.2f}%", avg_return)
            avg_return_item.setTextAlignment(Qt.AlignRight | Qt.AlignVCenter)
            avg_return_item.setFont(QFont("Arial", 10))
            if avg_return > 0:
                avg_return_item.setForeground(QBrush(QColor(COLORS['gain_light'])))
            elif avg_return < 0:
                avg_return_item.setForeground(QBrush(QColor(COLORS['loss_light'])))
            
            # è³‡æ–™ç­†æ•¸
            points_val = row['data_points']
            points_item = NumericTableWidgetItem(str(points_val), points_val)
            points_item.setTextAlignment(Qt.AlignCenter)
            points_item.setForeground(QBrush(QColor(COLORS['text_dim'])))
            
            # æœ€æ–°æ—¥æœŸ
            latest_date = pd.to_datetime(row['latest_date']).strftime('%Y/%m/%d')
            date_item = QTableWidgetItem(latest_date)
            date_item.setTextAlignment(Qt.AlignCenter)
            date_item.setForeground(QBrush(QColor(COLORS['text_dim'])))
            
            # çµ±è¨ˆæœŸé–“
            first_date = pd.to_datetime(row['first_date']).strftime('%m/%d')
            last_date = pd.to_datetime(row['last_date']).strftime('%m/%d')
            period_item = QTableWidgetItem(f"{first_date} ~ {last_date}")
            period_item.setTextAlignment(Qt.AlignCenter)
            period_item.setForeground(QBrush(QColor(COLORS['text_muted'])))
            
            # è¨­å®šè¡¨æ ¼é …ç›®
            self.ranking_table.setItem(i, 0, rank_item)
            self.ranking_table.setItem(i, 1, ticker_item)
            self.ranking_table.setItem(i, 2, name_item)
            self.ranking_table.setItem(i, 3, latest_return_item)
            self.ranking_table.setItem(i, 4, avg_return_item)
            self.ranking_table.setItem(i, 5, points_item)
            self.ranking_table.setItem(i, 6, date_item)
            self.ranking_table.setItem(i, 7, period_item)
        
        # é‡æ–°å•Ÿç”¨æ’åº
        self.ranking_table.setSortingEnabled(True)
        
        # æ›´æ–°åœ–è¡¨
        frequency_text = self.frequency_combo.currentText()
        self.top_chart.update_chart(df.head(20), f"ğŸ“ˆ {frequency_text} æ¼²å¹…æ’è¡Œ Top 20")
        self.bottom_chart.update_chart(df.tail(20), f"ğŸ“‰ {frequency_text} è·Œå¹…æ’è¡Œ Top 20")
        
        # æ›´æ–°ç‹€æ…‹
        self.status_label.setText(f"âœ… åˆ†æå®Œæˆ")
        self.status_label.setStyleSheet(f"color: {COLORS['success']}; font-size: 14px; font-weight: bold;")
        self.last_update_label.setText(f"æœ€å¾Œæ›´æ–°: {QDate.currentDate().toString('yyyy/MM/dd')} {time.strftime('%H:%M:%S')}")

    def filter_table(self):
        """éæ¿¾è¡¨æ ¼å…§å®¹"""
        search_text = self.search_input.text().lower()
        for row in range(self.ranking_table.rowCount()):
            ticker = self.ranking_table.item(row, 1).text().lower()
            name = self.ranking_table.item(row, 2).text().lower()
            if search_text in ticker or search_text in name:
                self.ranking_table.setRowHidden(row, False)
            else:
                self.ranking_table.setRowHidden(row, True)

    def toggle_auto_refresh(self, checked):
        """åˆ‡æ›è‡ªå‹•åˆ·æ–°"""
        if checked:
            self.auto_refresh_timer.start(300000)  # 5åˆ†é˜
            self.update_status("âš¡ è‡ªå‹•åˆ·æ–°å·²å•Ÿå‹• (æ¯5åˆ†é˜)")
        else:
            self.auto_refresh_timer.stop()
            self.update_status("âš¡ è‡ªå‹•åˆ·æ–°å·²åœç”¨")

    def export_data(self):
        """åŒ¯å‡ºæ•¸æ“š"""
        if self.current_df is None or self.current_df.empty:
            QMessageBox.warning(self, "åŒ¯å‡ºæé†’", "ç›®å‰æ²’æœ‰æ•¸æ“šå¯ä¾›åŒ¯å‡ºï¼Œè«‹å…ˆåŸ·è¡Œåˆ†æã€‚")
            return
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, "åŒ¯å‡ºå ±é…¬ç‡åˆ†æå ±è¡¨", "",
            "Excelæª”æ¡ˆ (*.xlsx);;CSVæª”æ¡ˆ (*.csv)"
        )
        
        if not file_path:
            return
        
        try:
            # æº–å‚™åŒ¯å‡ºè³‡æ–™
            export_df = self.current_df.copy()
            export_df['æ’å'] = range(1, len(export_df) + 1)
            export_df = export_df.rename(columns={
                'ticker': 'è‚¡ç¥¨ä»£ç¢¼',
                'name': 'è‚¡ç¥¨åç¨±',
                'latest_return_pct': 'æœ€æ–°å ±é…¬ç‡(%)',
                'avg_return_pct': 'å¹³å‡å ±é…¬ç‡(%)',
                'data_points': 'è³‡æ–™ç­†æ•¸',
                'latest_date': 'æœ€æ–°æ—¥æœŸ',
                'first_date': 'èµ·å§‹æ—¥æœŸ',
                'last_date': 'çµæŸæ—¥æœŸ'
            })
            
            # èª¿æ•´æ¬„ä½é †åº
            columns_order = ['æ’å', 'è‚¡ç¥¨ä»£ç¢¼', 'è‚¡ç¥¨åç¨±', 'æœ€æ–°å ±é…¬ç‡(%)', 
                           'å¹³å‡å ±é…¬ç‡(%)', 'è³‡æ–™ç­†æ•¸', 'æœ€æ–°æ—¥æœŸ', 'èµ·å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ']
            export_df = export_df[columns_order]
            
            if file_path.endswith('.xlsx'):
                # ExcelåŒ¯å‡ºï¼ŒåŠ å…¥æ ¼å¼åŒ–
                with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                    export_df.to_excel(writer, index=False, sheet_name='å ±é…¬ç‡åˆ†æ')
                    
                    # å–å¾—å·¥ä½œè¡¨
                    worksheet = writer.sheets['å ±é…¬ç‡åˆ†æ']
                    
                    # èª¿æ•´æ¬„ä½å¯¬åº¦
                    for column in worksheet.columns:
                        max_length = 0
                        column_letter = column[0].column_letter
                        for cell in column:
                            try:
                                if len(str(cell.value)) > max_length:
                                    max_length = len(str(cell.value))
                            except:
                                pass
                        adjusted_width = min(max_length + 2, 30)
                        worksheet.column_dimensions[column_letter].width = adjusted_width
            else:
                # CSVåŒ¯å‡º
                export_df.to_csv(file_path, index=False, encoding='utf-8-sig')
            
            QMessageBox.information(self, "åŒ¯å‡ºæˆåŠŸ", 
                                  f"å ±è¡¨å·²æˆåŠŸåŒ¯å‡ºè‡³:\n{file_path}\n\n"
                                  f"å…±åŒ¯å‡º {len(export_df)} ç­†è³‡æ–™")
        except Exception as e:
            QMessageBox.critical(self, "åŒ¯å‡ºéŒ¯èª¤", f"åŒ¯å‡ºå¤±æ•—: {str(e)}")

    def update_status(self, message):
        """æ›´æ–°ç‹€æ…‹è¨Šæ¯"""
        self.status_label.setText(f"â³ {message}")
        self.status_label.setStyleSheet(f"color: {COLORS['info']}; font-size: 14px; font-weight: bold;")

    def handle_error(self, error_message):
        """è™•ç†éŒ¯èª¤"""
        self.refresh_btn.setEnabled(True)
        self.status_label.setText(f"âŒ éŒ¯èª¤")
        self.status_label.setStyleSheet(f"color: {COLORS['error']}; font-size: 14px; font-weight: bold;")
        QMessageBox.critical(self, "æŸ¥è©¢éŒ¯èª¤", error_message)


def main():
    app = QApplication(sys.argv)
    app.setStyle('Fusion')  # ä½¿ç”¨ Fusion é¢¨æ ¼ä»¥ç²å¾—æ›´å¥½çš„å¤–è§€
    
    window = ReturnRankingWindow()
    window.show()
    
    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
